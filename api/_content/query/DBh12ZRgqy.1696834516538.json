{"_path":"/docs/team/services/shared/metric","_dir":"shared","_draft":false,"_partial":false,"_locale":"","title":"metric module","description":"","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"metric-module"},"children":[{"type":"text","value":"metric module"}]},{"type":"element","tag":"h2","props":{"id":"use-a-given-metric"},"children":[{"type":"text","value":"Use a given metric"}]},{"type":"element","tag":"pre","props":{"code":"# Import the metric\nfrom paxpar.services.shared.metric.ref import business_check_pdf_file\n\n# increment the metric (because it is a counter)\nbusiness_check_pdf_file.inc()\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"# Import the metric\nfrom paxpar.services.shared.metric.ref import business_check_pdf_file\n\n# increment the metric (because it is a counter)\nbusiness_check_pdf_file.inc()\n"}]}]},{"type":"element","tag":"h2","props":{"id":"fastapi-integration"},"children":[{"type":"text","value":"fastAPI integration"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The previous example will not work on its own\nbecause we need a web server to expose the "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"/metrics"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"We use fastAPI, this is a simple working example "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"example.py"}]},{"type":"text","value":" :"}]},{"type":"element","tag":"pre","props":{"code":"from prometheus_fastapi_instrumentator import Instrumentator\nfrom paxpar.services.shared.metric.ref import *\nfrom fastapi import FastAPI\n\napp = FastAPI()\nInstrumentator().instrument(app).expose(app)\n\n\n@app.get(\"/mypage\")\nasync def root():\n    # increment the metric (because it is a counter)\n    business_check_pdf_file.inc()\n    return {\"message\": \"business_check_pdf_file à été incrémenté\"}\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"from prometheus_fastapi_instrumentator import Instrumentator\nfrom paxpar.services.shared.metric.ref import *\nfrom fastapi import FastAPI\n\napp = FastAPI()\nInstrumentator().instrument(app).expose(app)\n\n\n@app.get(\"/mypage\")\nasync def root():\n    # increment the metric (because it is a counter)\n    business_check_pdf_file.inc()\n    return {\"message\": \"business_check_pdf_file à été incrémenté\"}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Run this example with :"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"poetry run uvicorn example:app --reload"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In your browser, hit several times "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"http://localhost:8000/mypage"}]},{"type":"text","value":"\nand look at the changing metrics at "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"http://localhost:8000/metrics"}]},{"type":"text","value":"."}]},{"type":"element","tag":"h2","props":{"id":"metric-reference"},"children":[{"type":"text","value":"Metric reference"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"All metric are defined in "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"paxpar.services.shared.metric.ref"}]},{"type":"text","value":"."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"To list all metrics :"}]},{"type":"element","tag":"pre","props":{"code":">>> from paxpar.services.shared import metric\n>>> metric.ref.all()\nid                             ! type     ! description                                ! labels\n-------------------------------+----------+--------------------------------------------+-------\nbusiness_check_pdf_file        ! Counter  ! PDF file processed by business_check       !\nbusiness_check_pdf_signature   ! Counter  ! PDF signature processed by business_check  ! psc, signer\n\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":">>> from paxpar.services.shared import metric\n>>> metric.ref.all()\nid                             ! type     ! description                                ! labels\n-------------------------------+----------+--------------------------------------------+-------\nbusiness_check_pdf_file        ! Counter  ! PDF file processed by business_check       !\nbusiness_check_pdf_signature   ! Counter  ! PDF signature processed by business_check  ! psc, signer\n\n"}]}]},{"type":"element","tag":"h2","props":{"id":"define-a-new-metric"},"children":[{"type":"text","value":"Define a new metric"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Add the new metric in "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"paxpar.services.shared.metric.ref"}]},{"type":"text","value":" :"}]},{"type":"element","tag":"pre","props":{"code":"my_new_metric = Counter('my_new_metric', 'My shiny new counter metric')\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"my_new_metric = Counter('my_new_metric', 'My shiny new counter metric')\n"}]}]},{"type":"element","tag":"h2","props":{"id":"promql"},"children":[{"type":"text","value":"promql"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"cf "},{"type":"element","tag":"a","props":{"href":"https://docs.victoriametrics.com/keyConcepts.html#instant-query","rel":["nofollow"]},"children":[{"type":"text","value":"https://docs.victoriametrics.com/keyConcepts.html#instant-query"}]}]},{"type":"element","tag":"pre","props":{"code":"pp_api_up{user=\"philippe.entzmann@gmail.com\", path=\"/api/pdf/check/\",domain=\"dev.paxpar.tech\",status=\"2xx\"}\n\n\npp_api_up{user=\"philippe.entzmann@gmail.com\", path=\"/api/pdf/check/\",domain=\"dev.paxpar.tech\",status=\"2xx\"}\n\n\nsum(pp_api_up{user=\"philippe.entzmann@gmail.com\"}) - (sum(pp_api_up{user=\"philippe.entzmann@gmail.com\"}) offset 5m)\n\nsum(pp_api_up{path=\"/api/pdf/check/\", status=\"2xx\"} default 0) - sum(pp_api_up{path=\"/api/pdf/check/\", status=\"2xx\"} offset 1200m default 0)\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"pp_api_up{user=\"philippe.entzmann@gmail.com\", path=\"/api/pdf/check/\",domain=\"dev.paxpar.tech\",status=\"2xx\"}\n\n\npp_api_up{user=\"philippe.entzmann@gmail.com\", path=\"/api/pdf/check/\",domain=\"dev.paxpar.tech\",status=\"2xx\"}\n\n\nsum(pp_api_up{user=\"philippe.entzmann@gmail.com\"}) - (sum(pp_api_up{user=\"philippe.entzmann@gmail.com\"}) offset 5m)\n\nsum(pp_api_up{path=\"/api/pdf/check/\", status=\"2xx\"} default 0) - sum(pp_api_up{path=\"/api/pdf/check/\", status=\"2xx\"} offset 1200m default 0)\n"}]}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"use-a-given-metric","depth":2,"text":"Use a given metric"},{"id":"fastapi-integration","depth":2,"text":"fastAPI integration"},{"id":"metric-reference","depth":2,"text":"Metric reference"},{"id":"define-a-new-metric","depth":2,"text":"Define a new metric"},{"id":"promql","depth":2,"text":"promql"}]}},"_type":"markdown","_id":"content:10.docs:80.team:10.services:shared:metric.md","_source":"content","_file":"10.docs/80.team/10.services/shared/metric.md","_extension":"md"}